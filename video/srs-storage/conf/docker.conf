# the config for srs to dvr in session mode
# @see https://github.com/ossrs/srs/wiki/v3_CN_DVR
# @see full.conf for detail config.

listen              1935;
max_connections     1000;
#srs_log_tank        file;
#srs_log_file        ./objs/srs.log;

# 注意使用 docker 运行时 这里必须要设为 off
daemon              off;

http_api {
    enabled         on;
    listen          1985;
}

http_server {
    enabled         on;
    listen          8080;
    dir             ./objs/nginx/html;
}

vhost __defaultVhost__ {
    
    hls {
        enabled         off;
        hls_fragment    5;
    }
    
    http_remux {
        # 启用http-flv
        enabled     on;
        mount       [vhost]/[app]/[stream].flv;
        has_audio off;           # ✅ 允许没有音频（或中途音频丢失/静音）
        has_video on;            # ✅ 要求必须有视频（一般默认就是 on）
        drop_if_not_match off;   # ✅ 不因为音视频结构不完整就丢弃连接
        guess_has_av on;         # ✅ 启用智能判断，容忍前几帧无音频
    }
    
    tcp_nodelay     on;
    min_latency     on;
    
    #play {
    #    gop_cache       off;
    #    queue_length    10;
    #    mw_latency      100;
    #}
    
    publish {
    #    mr off;
        # default: 5000 超时 srs 会主动断开推流者的连接
        normal_timeout 12000;
    }
    
    dvr {
        enabled      on;
        # .flv .mp4
        #dvr_path     ./objs/nginx/html/[app]/[stream]/[timestamp].flv;
        dvr_path     ./objs/nginx/html/dvr/[app]/[stream]/[timestamp].mp4;
        dvr_plan     segment;
        # 分割时长 30=30秒 900=900秒
        dvr_duration    90;
        dvr_wait_keyframe       on;
    }
}
